<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Jump Counting Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style> 
    body { 
      margin: 0; 
      font-family: Arial, sans-serif; 
      background-color: #3c9aaa; /* n·ªÅn t√≠m */
      display: flex;
      justify-content: center; /* cƒÉn gi·ªØa ngang */
      align-items: center;     /* cƒÉn gi·ªØa d·ªçc */
      height: 100vh;           /* full m√†n h√¨nh */
    } 
    
    #game-container {
      position: relative;
      width: 600px;   /* kh·ªõp v·ªõi canvas */
      height: 600px;
    }

    #game-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
    
    #instructions {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
      font-size: 14px;
    }
    
    #checkpoint-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: gold;
      padding: 20px;
      border-radius: 10px;
      z-index: 20;
      text-align: center;
      display: none;
      font-size: 24px;
      font-weight: bold;
    }
    
    #result-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px;
      border-radius: 15px;
      z-index: 30;
      text-align: center;
      display: none;
      font-size: 24px;
      font-weight: bold;
      width: 80%;
      max-width: 500px;
    }
    
    .hidden {
      display: none !important;
    }
    
    #score-display {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
    
    #timer-display {
      position: absolute;
      top: 10px;
      right: 150px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="game-overlay">
      <h2>ƒê·∫øm s·ªë l√™n 50</h2>
      <p>M·ª©c hi·ªán t·∫°i: <span id="current-level">1</span>/50</p>
    </div>
    
    <div id="timer-display">
      <p>Th·ªùi gian: <span id="timer">0.00</span>s</p>
    </div>
    
    <div id="score-display">
      <p>ƒêi·ªÉm: <span id="score">0</span></p>
    </div>
    
    <div id="instructions">
      <p>Nh·∫•p v√†o c√°c s·ªë theo th·ª© t·ª± t·ª´ 1 ƒë·∫øn 50. Nh·∫•n R ƒë·ªÉ ch∆°i l·∫°i.</p>
    </div>
    
    <div id="checkpoint-message"></div>
    <div id="result-box" class="hidden"></div>
  </div>

<script>
let player;
let rows = 50;
let platforms = [];
let camY = 0;
let worldHeight;
let currentTarget = 1;
let isFalling = false;
let gravity = 0.8;
let jumpSpeed = 12;
let startPlatform;
let treasurePlatform;
let gameWon = false;
let stoneImg, backgroundImg, playerImg, islandImg, jumpingImg;
let bgVideo;
let checkpoints = [];
let showCheckpointMessage = false;
let checkpointTimer = 0;

// Bi·∫øn t√≠nh ƒëi·ªÉm v√† th·ªùi gian
let score = 0;
let startTime = null;
let timerInterval = null;

function preload() {
  // S·ª≠ d·ª•ng ·∫£nh m·∫´u t·ª´ internet thay v√¨ file local
  stoneImg = loadImage('https://images.unsplash.com/photo-1586348943529-beaae6c28db9?w=150&h=80&fit=crop');
  backgroundImg = loadImage('https://images.unsplash.com/photo-1501426026826-31c667bdf23d?w=600&h=600&fit=crop');
  playerImg = loadImage('https://images.unsplash.com/photo-1560807707-8cc77767d783?w=60&h=60&fit=crop&crop=face');
  jumpingImg = loadImage('https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=60&h=60&fit=crop');
  islandImg = loadImage('https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=250&h=100&fit=crop');
}

function setup() {
  createCanvas(600, 600);

  // T·∫°o video n·ªÅn gi·∫£ (th·ª±c t·∫ø s·∫Ω d√πng video c·ªßa b·∫°n)
  bgVideo = createVideo('');
  bgVideo.hide();
  
  worldHeight = (rows + 2) * 180;
  generatePlatforms();
  
  // T·∫°o c√°c m·ªëc ki·ªÉm tra (m·ªói 10 s·ªë)
  for (let i = 1; i <= 5; i++) {
    checkpoints.push(i * 10);
  }

  player = {
    x: startPlatform.x + 75,
    y: startPlatform.y - 20,
    size: 60,
    vy: 0,
    isJumping: false,
    targetX: startPlatform.x + 75,
    targetY: startPlatform.y - 20,
    jumpProgress: 0,
    isAnimating: false,
    isJumpingImg: false
  };
  
  // B·∫Øt ƒë·∫ßu t√≠nh th·ªùi gian
  startTimer();
}

function generatePlatforms() {
  platforms = [];
  
  // T·∫°o platform b·∫Øt ƒë·∫ßu (s·ªë 0)
  startPlatform = {
    x: width / 2 - 75,
    y: worldHeight - 60,
    label: 0,
    row: -1,
    isStart: true
  };
  
  // T·∫°o c√°c platform cho t·ª´ng h√†ng (1-50)
  for (let i = 0; i < rows; i++) {
    let y = worldHeight - (i + 2) * 160;
    let correctAnswer = i + 1;
    
    // T·∫°o 3 platform nh∆∞ng ch·ªâ 1 ƒë√∫ng
    let row = [];
    let wrongAnswers = [];
    
    // T·∫°o 2 ƒë√°p √°n sai v·ªõi gi√° tr·ªã g·∫ßn ƒë√°p √°n ƒë√∫ng
    let wrong1 = correctAnswer - 1;
    let wrong2 = correctAnswer + 1;
    
    // ƒê·∫£m b·∫£o ƒë√°p √°n sai n·∫±m trong kho·∫£ng 1-50
    if (wrong1 < 1) wrong1 = correctAnswer + 2;
    if (wrong2 > 50) wrong2 = correctAnswer - 2;
    
    wrongAnswers.push(wrong1, wrong2);
    
    // Tr·ªôn ƒë√°p √°n v√† ƒë·∫∑t v√†o 3 v·ªã tr√≠
    let answers = [correctAnswer, ...wrongAnswers];
    answers = shuffle(answers);
    
    for (let j = 0; j < 3; j++) {
      let x = 75 + j * 180;
      row.push({ 
        x, 
        y, 
        label: answers[j], 
        row: i,
        isCorrect: answers[j] === correctAnswer,
        isCheckpoint: checkpoints.includes(answers[j])
      });
    }
    platforms.push(row);
  }
  
  // T·∫°o platform kho b√°u (s·ªë 51)
  treasurePlatform = {
    x: width / 2 - 65,
    y: worldHeight - (rows + 2) * 160,
    label: 51,
    row: rows,
    isTreasure: true
  };
}

function draw() {
  // V·∫Ω background
  if (backgroundImg) {
    image(backgroundImg, 0, 0, width, height);
  } else {
    background(135, 206, 235);
  }
  
  // C·∫≠p nh·∫≠t UI
  document.getElementById('current-level').textContent = currentTarget;
  
  updateCamera();

  push();
  translate(0, camY);

  // V·∫Ω platform b·∫Øt ƒë·∫ßu
  drawPlatform(startPlatform);
  
  // V·∫Ω c√°c platform game
  for (let row of platforms) {
    for (let p of row) {
      if (!p.isHidden) {
        drawPlatform(p);
      }
    }
  }
  
  // V·∫Ω kho b√°u
  drawTreasure(treasurePlatform);

  // C·∫≠p nh·∫≠t animation nh√¢n v·∫≠t
  updatePlayer();

  // V·∫Ω nh√¢n v·∫≠t
  if (player.isJumpingImg && jumpingImg) {
    image(jumpingImg, player.x - player.size/2, player.y - player.size/2, player.size, player.size);
  } else if (playerImg) {
    tint(isFalling ? color(255, 100, 100) : color(255, 255, 255));
    image(playerImg, player.x - player.size/2, player.y - player.size/2, player.size, player.size);
    noTint();
  } else {
    fill(isFalling ? color(255, 100, 100) : color(100, 255, 100));
    stroke(50);
    strokeWeight(2);
    ellipse(player.x, player.y, player.size);
  }

  pop();

  applyGravity();
  
  // Hi·ªÉn th·ªã th√¥ng b√°o m·ªëc ki·ªÉm tra n·∫øu c·∫ßn
  if (showCheckpointMessage) {
    checkpointTimer++;
    if (checkpointTimer > 120) { // Hi·ªÉn th·ªã trong 2 gi√¢y (120 frame)
      showCheckpointMessage = false;
      checkpointTimer = 0;
      document.getElementById('checkpoint-message').style.display = 'none';
    }
  }
}

function drawPlatform(p) {
  // V·∫Ω n·ªÅn platform b·∫±ng ·∫£nh stone
  if (stoneImg) {
    image(stoneImg, p.x, p.y, 150, 80);
  } else {
    // Fallback n·∫øu kh√¥ng c√≥ ·∫£nh
    if (p.isCheckpoint) {
      fill(255, 215, 0);
      stroke(218, 165, 32);
    } else if (p.isStart) {
      fill(139, 69, 19);
      stroke(101, 67, 33);
    } else {
      fill(150, 150, 150);
      stroke(100, 100, 100);
    }
    strokeWeight(2);
    rect(p.x, p.y, 150, 80, 8);
  }
  
  // V·∫Ω s·ªë
  fill(p.isCheckpoint ? 0 : 255);
  stroke(0);
  strokeWeight(1);
  textAlign(CENTER, CENTER);
  textSize(24);
  textStyle(BOLD);
  text(p.label, p.x + 75, p.y + 40);
}

function drawTreasure(p) {
  // V·∫Ω kho b√°u
  if (islandImg) {
    image(islandImg, p.x-35, p.y-70, 250, 100);
  } else {
    fill(255, 215, 0);
    stroke(218, 165, 32);
    strokeWeight(4);
    rect(p.x, p.y, 250, 100, 20);
  }
  
  // V·∫Ω bi·ªÉu t∆∞·ª£ng kho b√°u
  fill(255, 140, 0);
  stroke(0);
  strokeWeight(1);
  textAlign(CENTER, CENTER);
  textSize(28);
  text("üíé", p.x + 125, p.y + 50);
}

function updatePlayer() {
  if (player.isAnimating) {
    player.jumpProgress += 0.02;
    
    if (player.jumpProgress >= 1) {
      player.jumpProgress = 1;
      player.isAnimating = false;
      player.isJumping = false;
      player.isJumpingImg = false;
    }
    
    let t = easeInOutQuad(player.jumpProgress);
    player.x = lerp(player.x, player.targetX, t * 0.15);
    player.y = lerp(player.y, player.targetY, t * 0.15);
  }
}

function easeInOutQuad(t) {
  return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
}

function updateCamera() {
  let targetCamY = -player.y + height / 2;
  targetCamY = constrain(targetCamY, -worldHeight + height, 0);
  camY = lerp(camY, targetCamY, 0.1);
}

function applyGravity() {
  if ((player.isJumping || isFalling) && !player.isAnimating) {
    player.vy += gravity;
    player.y += player.vy;
  }

  // R∆°i xu·ªëng ƒë√°y
  if (player.y > worldHeight + 200) {
    noLoop();
    // Hi·ªÉn th·ªã game over kh√¥ng d√πng alert
    document.getElementById('checkpoint-message').textContent = "Game Over! B·∫°n ƒë√£ r∆°i xu·ªëng. Nh·∫•n R ƒë·ªÉ ch∆°i l·∫°i.";
    document.getElementById('checkpoint-message').style.display = 'block';
    showCheckpointMessage = true;
    endGame(false);
  }
}

function mousePressed() {
  if (player.isJumping || isFalling || gameWon || player.isAnimating) return;

  let mouseYWorld = mouseY - camY;
  let mouseXWorld = mouseX;

  // Ki·ªÉm tra click v√†o platform th∆∞·ªùng
  for (let row of platforms) {
    for (let p of row) {
      if (!p.isHidden && isClickInPlatform(mouseXWorld, mouseYWorld, p)) {
        if (p.label === currentTarget) {
          jumpTo(p);
          hideWrongAnswers(p.row);
          currentTarget++;
          
          // C·ªông ƒëi·ªÉm cho m·ªói b∆∞·ªõc ƒë√∫ng
          score += 10;
          document.getElementById('score').textContent = score;
          
          // Ki·ªÉm tra n·∫øu ƒë·∫°t m·ªëc
          if (checkpoints.includes(p.label)) {
            document.getElementById('checkpoint-message').textContent = `Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t m·ªëc ${p.label}!`;
            document.getElementById('checkpoint-message').style.display = 'block';
            showCheckpointMessage = true;
            checkpointTimer = 0;
          }
          
          if (currentTarget > rows) {
            // K√≠ch ho·∫°t kho b√°u
          }
        } else {
          fallDown();
        }
        return;
      }
    }
  }
  
  // Ki·ªÉm tra click v√†o kho b√°u
  if (currentTarget > rows && isClickInPlatform(mouseXWorld, mouseYWorld, treasurePlatform)) {
    jumpTo(treasurePlatform);
    setTimeout(() => {
      gameWon = true;
      noLoop();
      document.getElementById('checkpoint-message').textContent = "üèÜ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh game v√† t√¨m ƒë∆∞·ª£c kho b√°u!";
      document.getElementById('checkpoint-message').style.display = 'block';
      endGame(true);
    }, 1000);
  }
}

function isClickInPlatform(mouseX, mouseY, platform) {
  return mouseX >= platform.x && 
         mouseX <= platform.x + 150 && 
         mouseY >= platform.y && 
         mouseY <= platform.y + 80;
}

function jumpTo(platform) {
  player.isJumping = true;
  player.isAnimating = true;
  player.isJumpingImg = true;
  player.jumpProgress = 0;
  player.targetY = platform.y - 10;
  player.targetX = platform.x + 75;
}

function fallDown() {
  isFalling = true;
  player.vy = 5;
}

function hideWrongAnswers(rowIndex) {
  // ·∫®n t·∫•t c·∫£ c√°c ƒë√°p √°n sai trong h√†ng n√†y
  for (let p of platforms[rowIndex]) {
    if (!p.isCorrect) {
      p.isHidden = true;
    }
  }
}

function keyPressed() {
  if (key === 'r' || key === 'R') {
    // Reset game
    currentTarget = 1;
    isFalling = false;
    gameWon = false;
    score = 0;
    document.getElementById('score').textContent = score;
    generatePlatforms();
    player.x = startPlatform.x + 75;
    player.y = startPlatform.y - 20;
    player.vy = 0;
    player.isJumping = false;
    player.isAnimating = false;
    player.isJumpingImg = false;
    player.jumpProgress = 0;
    document.getElementById('checkpoint-message').style.display = 'none';
    document.getElementById('result-box').classList.add('hidden');
    startTimer();
    loop();
  }
}

// H√†m t√≠nh th·ªùi gian
function startTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
  }
  startTime = performance.now();
  timerInterval = setInterval(updateTimer, 100);
}

function updateTimer() {
  if (startTime) {
    const elapsed = (performance.now() - startTime) / 1000;
    document.getElementById('timer').textContent = elapsed.toFixed(2);
  }
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

// H√†m k·∫øt th√∫c game
function endGame(isWin) {
  stopTimer();
  const elapsed = startTime ? (performance.now() - startTime)/1000 : 0;
  
  const resultBox = document.getElementById('result-box');
  resultBox.classList.remove('hidden');
  
  if (isWin) {
    resultBox.innerHTML = `üéâ Ho√†n th√†nh! ƒêi·ªÉm: <span style="color:gold">${score}</span> ‚Äî Th·ªùi gian: <strong>${elapsed.toFixed(2)}s</strong>`;
  } else {
    resultBox.innerHTML = `üí• Game Over! ƒêi·ªÉm: <span style="color:gold">${score}</span> ‚Äî Th·ªùi gian: <strong>${elapsed.toFixed(2)}s</strong>`;
  }

  // üü¢ G·ª¨I ƒêI·ªÇM L√äN SERVER
  const username = localStorage.getItem('username') || prompt("Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i c·ªßa b·∫°n:");
  if (username) {
    localStorage.setItem('username', username); // l∆∞u ƒë·ªÉ l·∫ßn sau kh·ªèi h·ªèi l·∫°i
    fetch("http://210.245.52.119/api_gamedemso/api/scores/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: username,
        gameId: 3,          // id game trong b·∫£ng games, t√πy b·∫°n ƒë·∫∑t
        score: score,
        timeTaken: elapsed
      })
    })
    .then(res => res.json())
    .then(data => {
      console.log("K·∫øt qu·∫£ l∆∞u ƒëi·ªÉm:", data);
      if (data.success) {
        resultBox.innerHTML += "<br><span style='color:#10b981'>‚úÖ ƒêi·ªÉm ƒë√£ ƒë∆∞·ª£c l∆∞u!</span>";
      } else {
        resultBox.innerHTML += "<br><span style='color:#ef4444'>‚ùå L∆∞u ƒëi·ªÉm th·∫•t b·∫°i: " + data.message + "</span>";
      }
    })
    .catch(err => {
      console.error("L·ªói l∆∞u ƒëi·ªÉm:", err);
      resultBox.innerHTML += "<br><span style='color:#ef4444'>‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server.</span>";
    });
  } else {
    resultBox.innerHTML += "<br><span style='color:#facc15'>‚ö†Ô∏è Kh√¥ng l∆∞u ƒëi·ªÉm (ch∆∞a nh·∫≠p t√™n).</span>";
  }
}
</script>
</body>
</html>